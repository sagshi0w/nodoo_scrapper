name: Job Matching System

on:
  schedule:
    - cron: "30 0 * * *"  # 6:00 AM IST (00:30 UTC)
  workflow_dispatch: # Manual trigger option

jobs:
  run-job-matching:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üì¶ Install Project Dependencies
        run: npm install

      - name: üèÉ Run Job Matching Process
        id: job_matching
        run: npm run job-matching 2>&1 | tee job_matching_output.txt
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_DB_COLLECTION_NAME: ${{ secrets.MONGO_DB_COLLECTION_NAME }}
          EMAIL_USER: ${{ secrets.MAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENT }}

      - name: üìä Create Summary Table
        if: success()
        id: summary
        run: |
          echo "## üìä Job Matching Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Extract values from output
          TOTAL_JOBS=$(grep -oP 'Total Jobs Processed: \K\d+' job_matching_output.txt || echo "N/A")
          TOTAL_PROFILES=$(grep -oP 'Total Profiles Processed: \K\d+' job_matching_output.txt || echo "N/A")
          TOTAL_MATCHES=$(grep -oP 'Total Matches Found: \K\d+' job_matching_output.txt || echo "N/A")
          USERS_WITH_MATCHES=$(grep -oP 'Users with Matches: \K\d+' job_matching_output.txt || echo "N/A")
          EXCELLENT_MATCHES=$(grep -oP 'Excellent Matches.*: \K\d+' job_matching_output.txt || echo "N/A")
          GOOD_MATCHES=$(grep -oP 'Good Matches.*: \K\d+' job_matching_output.txt || echo "N/A")
          AVG_RECOMMENDATIONS=$(grep -oP 'Average Recommendations per User: \K\d+' job_matching_output.txt || echo "N/A")
          PROCESSING_TIME=$(grep -oP 'Processing Time: \K\d+' job_matching_output.txt || echo "N/A")
          
          echo "| Total Jobs Processed | $TOTAL_JOBS |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Profiles Processed | $TOTAL_PROFILES |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Matches Found | $TOTAL_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Users with Matches | $USERS_WITH_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Excellent Matches (‚â•85%) | $EXCELLENT_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Good Matches (‚â•70%) | $GOOD_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Recommendations per User | $AVG_RECOMMENDATIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| Processing Time (seconds) | $PROCESSING_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract users with matches details
          echo "### üë• Users with Job Matches" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SR No | User Name | Skills | Jobs Found |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          
          # Extract user details from output (format: "User X: name | Skills: skills | Jobs: count")
          SR_NO=1
          IN_USER_SECTION=false
          while IFS= read -r line; do
            # Check if we're in the user details section
            if echo "$line" | grep -q "=== Users with Matches Details ==="; then
              IN_USER_SECTION=true
              continue
            fi
            
            # Stop if we hit the next section
            if [ "$IN_USER_SECTION" = true ] && echo "$line" | grep -qE "^==="; then
              IN_USER_SECTION=false
            fi
            
            # Parse user line
            if [ "$IN_USER_SECTION" = true ] && echo "$line" | grep -qE "User [0-9]+:"; then
              USER_NAME=$(echo "$line" | sed -E 's/.*User [0-9]+: ([^|]+) \|.*/\1/' | xargs)
              USER_SKILLS=$(echo "$line" | sed -E 's/.*Skills: ([^|]+) \|.*/\1/' | xargs)
              JOB_COUNT=$(echo "$line" | sed -E 's/.*Jobs: ([0-9]+).*/\1/' | xargs)
              
              if [ -n "$USER_NAME" ] && [ "$USER_NAME" != "$line" ]; then
                # Truncate skills if too long
                if [ ${#USER_SKILLS} -gt 50 ]; then
                  USER_SKILLS="${USER_SKILLS:0:47}..."
                fi
                echo "| $SR_NO | $USER_NAME | $USER_SKILLS | $JOB_COUNT |" >> $GITHUB_STEP_SUMMARY
                SR_NO=$((SR_NO + 1))
              fi
            fi
          done < job_matching_output.txt
          
          if [ $SR_NO -eq 1 ]; then
            echo "| - | No users with matches | - | - |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Job matching completed successfully!" >> $GITHUB_STEP_SUMMARY
          
          # Extract user details for email table
          SR_NO=1
          USER_TABLE_ROWS=""
          IN_USER_SECTION=false
          while IFS= read -r line; do
            # Check if we're in the user details section
            if echo "$line" | grep -q "=== Users with Matches Details ==="; then
              IN_USER_SECTION=true
              continue
            fi
            
            # Stop if we hit the next section
            if [ "$IN_USER_SECTION" = true ] && echo "$line" | grep -qE "^==="; then
              IN_USER_SECTION=false
            fi
            
            # Parse user line
            if [ "$IN_USER_SECTION" = true ] && echo "$line" | grep -qE "User [0-9]+:"; then
              USER_NAME=$(echo "$line" | sed -E 's/.*User [0-9]+: ([^|]+) \|.*/\1/' | xargs)
              USER_SKILLS=$(echo "$line" | sed -E 's/.*Skills: ([^|]+) \|.*/\1/' | xargs)
              JOB_COUNT=$(echo "$line" | sed -E 's/.*Jobs: ([0-9]+).*/\1/' | xargs)
              
              if [ -n "$USER_NAME" ] && [ "$USER_NAME" != "$line" ]; then
                # Escape HTML special characters
                USER_NAME_ESC=$(echo "$USER_NAME" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
                USER_SKILLS_ESC=$(echo "$USER_SKILLS" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
                USER_TABLE_ROWS="${USER_TABLE_ROWS}<tr><td style=\"border:1px solid #ddd;padding:8px;\">${SR_NO}</td><td style=\"border:1px solid #ddd;padding:8px;\">${USER_NAME_ESC}</td><td style=\"border:1px solid #ddd;padding:8px;\">${USER_SKILLS_ESC}</td><td style=\"border:1px solid #ddd;padding:8px;\">${JOB_COUNT}</td></tr>"
                SR_NO=$((SR_NO + 1))
              fi
            fi
          done < job_matching_output.txt
          
          if [ -z "$USER_TABLE_ROWS" ]; then
            USER_TABLE_ROWS="<tr><td colspan=\"4\" style=\"border:1px solid #ddd;padding:8px;text-align:center;\">No users with matches</td></tr>"
          fi
          
          # Write USER_TABLE_ROWS directly to GITHUB_ENV (can't use summary.env due to HTML characters)
          echo "USER_TABLE_ROWS<<EOF" >> $GITHUB_ENV
          echo "$USER_TABLE_ROWS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Save values to file for email step
          echo "TOTAL_JOBS=$TOTAL_JOBS" >> summary.env
          echo "TOTAL_PROFILES=$TOTAL_PROFILES" >> summary.env
          echo "TOTAL_MATCHES=$TOTAL_MATCHES" >> summary.env
          echo "USERS_WITH_MATCHES=$USERS_WITH_MATCHES" >> summary.env
          echo "EXCELLENT_MATCHES=$EXCELLENT_MATCHES" >> summary.env
          echo "GOOD_MATCHES=$GOOD_MATCHES" >> summary.env
          echo "AVG_RECOMMENDATIONS=$AVG_RECOMMENDATIONS" >> summary.env
          echo "PROCESSING_TIME=$PROCESSING_TIME" >> summary.env

      - name: üìß Load Summary Values
        if: success()
        run: |
          if [ -f summary.env ]; then
            # Read summary.env line by line and only process valid variable assignments
            # This avoids issues with HTML content that might be in the file
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines and lines that don't look like variable assignments
              if [ -z "$line" ] || ! echo "$line" | grep -qE '^[A-Z_]+='; then
                continue
              fi
              
              # Skip lines with HTML tags (these would cause syntax errors)
              if echo "$line" | grep -qE '<[^>]+>'; then
                continue
              fi
              
              # Extract variable name and value
              VAR_NAME=$(echo "$line" | cut -d'=' -f1)
              VAR_VALUE=$(echo "$line" | cut -d'=' -f2-)
              
              # Only set known variables
              case "$VAR_NAME" in
                TOTAL_JOBS|TOTAL_PROFILES|TOTAL_MATCHES|USERS_WITH_MATCHES|EXCELLENT_MATCHES|GOOD_MATCHES|AVG_RECOMMENDATIONS|PROCESSING_TIME)
                  echo "${VAR_NAME}=${VAR_VALUE}" >> $GITHUB_ENV
                  ;;
              esac
            done < summary.env
          fi
          
          # USER_TABLE_ROWS is already written to GITHUB_ENV in the previous step using heredoc
          # No need to load it again from summary.env

      - name: ‚úÖ Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Job Matching Success: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          content_type: text/html
          body: |
            <html>
            <body style="font-family: Arial, sans-serif;">
              <p>‚úÖ The job matching ran successfully at 6:00 AM IST.</p>
              <p>üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}</p>
              
              <h3>üìä Summary Table</h3>
              <table style="border-collapse:collapse;width:100%;margin-bottom:20px;">
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Total Jobs Processed</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.TOTAL_JOBS || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Total Profiles Processed</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.TOTAL_PROFILES || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Total Matches Found</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.TOTAL_MATCHES || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Users with Matches</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.USERS_WITH_MATCHES || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Excellent Matches (‚â•85%)</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.EXCELLENT_MATCHES || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Good Matches (‚â•70%)</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.GOOD_MATCHES || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Avg Recommendations per User</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.AVG_RECOMMENDATIONS || 'N/A' }}</td>
                </tr>
                <tr>
                  <td style="border:1px solid #ddd;padding:8px;"><strong>Processing Time (seconds)</strong></td>
                  <td style="border:1px solid #ddd;padding:8px;">${{ env.PROCESSING_TIME || 'N/A' }}</td>
                </tr>
              </table>
              
              <h3>üë• Users with Job Matches</h3>
              <table style="border-collapse:collapse;width:100%;">
                <thead>
                  <tr>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;background-color:#f2f2f2;">SR No</th>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;background-color:#f2f2f2;">User Name</th>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;background-color:#f2f2f2;">Skills</th>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;background-color:#f2f2f2;">Jobs Found</th>
                  </tr>
                </thead>
                <tbody>
                  ${{ env.USER_TABLE_ROWS || '<tr><td colspan="4" style="border:1px solid #ddd;padding:8px;text-align:center;">No users with matches</td></tr>' }}
                </tbody>
              </table>
            </body>
            </html>

      - name: ‚ùå Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Job Matching Failed: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          content_type: text/html
          body: |
            <html>
            <body style="font-family: Arial, sans-serif;">
              <p>‚ùå The job matching failed to complete successfully.</p>
              <p>üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}</p>
            </body>
            </html>
