name: Job Matching System

on:
  schedule:
    - cron: "30 0 * * *"  # 6:00 AM IST (00:30 UTC)
  workflow_dispatch: # Manual trigger option

jobs:
  run-job-matching:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üì¶ Install Project Dependencies
        run: npm install

      - name: üèÉ Run Job Matching Process
        id: job_matching
        run: npm run job-matching 2>&1 | tee job_matching_output.txt
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_DB_COLLECTION_NAME: ${{ secrets.MONGO_DB_COLLECTION_NAME }}
          EMAIL_USER: ${{ secrets.MAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENT }}

      - name: üìä Create Summary Table
        if: success()
        id: summary
        run: |
          echo "## üìä Job Matching Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Extract values from output
          TOTAL_JOBS=$(grep -oP 'Total Jobs Processed: \K\d+' job_matching_output.txt || echo "N/A")
          TOTAL_PROFILES=$(grep -oP 'Total Profiles Processed: \K\d+' job_matching_output.txt || echo "N/A")
          TOTAL_MATCHES=$(grep -oP 'Total Matches Found: \K\d+' job_matching_output.txt || echo "N/A")
          USERS_WITH_MATCHES=$(grep -oP 'Users with Matches: \K\d+' job_matching_output.txt || echo "N/A")
          EXCELLENT_MATCHES=$(grep -oP 'Excellent Matches.*: \K\d+' job_matching_output.txt || echo "N/A")
          GOOD_MATCHES=$(grep -oP 'Good Matches.*: \K\d+' job_matching_output.txt || echo "N/A")
          AVG_RECOMMENDATIONS=$(grep -oP 'Average Recommendations per User: \K\d+' job_matching_output.txt || echo "N/A")
          PROCESSING_TIME=$(grep -oP 'Processing Time: \K\d+' job_matching_output.txt || echo "N/A")
          
          echo "| Total Jobs Processed | $TOTAL_JOBS |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Profiles Processed | $TOTAL_PROFILES |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Matches Found | $TOTAL_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Users with Matches | $USERS_WITH_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Excellent Matches (‚â•85%) | $EXCELLENT_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Good Matches (‚â•70%) | $GOOD_MATCHES |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Recommendations per User | $AVG_RECOMMENDATIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| Processing Time (seconds) | $PROCESSING_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Job matching completed successfully!" >> $GITHUB_STEP_SUMMARY
          
          # Save values to file for email step
          echo "TOTAL_JOBS=$TOTAL_JOBS" >> summary.env
          echo "TOTAL_PROFILES=$TOTAL_PROFILES" >> summary.env
          echo "TOTAL_MATCHES=$TOTAL_MATCHES" >> summary.env
          echo "USERS_WITH_MATCHES=$USERS_WITH_MATCHES" >> summary.env
          echo "EXCELLENT_MATCHES=$EXCELLENT_MATCHES" >> summary.env
          echo "GOOD_MATCHES=$GOOD_MATCHES" >> summary.env
          echo "AVG_RECOMMENDATIONS=$AVG_RECOMMENDATIONS" >> summary.env
          echo "PROCESSING_TIME=$PROCESSING_TIME" >> summary.env

      - name: üìß Load Summary Values
        if: success()
        run: |
          if [ -f summary.env ]; then
            set -a
            source summary.env
            set +a
            echo "TOTAL_JOBS=$TOTAL_JOBS" >> $GITHUB_ENV
            echo "TOTAL_PROFILES=$TOTAL_PROFILES" >> $GITHUB_ENV
            echo "TOTAL_MATCHES=$TOTAL_MATCHES" >> $GITHUB_ENV
            echo "USERS_WITH_MATCHES=$USERS_WITH_MATCHES" >> $GITHUB_ENV
            echo "EXCELLENT_MATCHES=$EXCELLENT_MATCHES" >> $GITHUB_ENV
            echo "GOOD_MATCHES=$GOOD_MATCHES" >> $GITHUB_ENV
            echo "AVG_RECOMMENDATIONS=$AVG_RECOMMENDATIONS" >> $GITHUB_ENV
            echo "PROCESSING_TIME=$PROCESSING_TIME" >> $GITHUB_ENV
          fi

      - name: ‚úÖ Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Job Matching Success: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ‚úÖ The job matching ran successfully at 6:00 AM IST.
            üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}
            
            ## üìä Summary Table
            
            | Metric | Value |
            |--------|-------|
            | Total Jobs Processed | ${{ env.TOTAL_JOBS || 'N/A' }} |
            | Total Profiles Processed | ${{ env.TOTAL_PROFILES || 'N/A' }} |
            | Total Matches Found | ${{ env.TOTAL_MATCHES || 'N/A' }} |
            | Users with Matches | ${{ env.USERS_WITH_MATCHES || 'N/A' }} |
            | Excellent Matches (‚â•85%) | ${{ env.EXCELLENT_MATCHES || 'N/A' }} |
            | Good Matches (‚â•70%) | ${{ env.GOOD_MATCHES || 'N/A' }} |
            | Avg Recommendations per User | ${{ env.AVG_RECOMMENDATIONS || 'N/A' }} |
            | Processing Time (seconds) | ${{ env.PROCESSING_TIME || 'N/A' }} |

      - name: ‚ùå Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Job Matching Failed: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ‚ùå The job matching failed to complete successfully.
            üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}
