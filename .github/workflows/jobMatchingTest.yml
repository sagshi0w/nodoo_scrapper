name: Job Matching Test

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'connection'
        type: choice
        options:
        - connection
        - matching

jobs:
  test-job-matching:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Repo
        uses: actions/checkout@v4

      - name: ⚙️ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: 📦 Install Project Dependencies
        run: npm install

      - name: 🔍 Test Database Connection
        if: ${{ github.event.inputs.test_type == 'connection' }}
        run: npm run test-connection
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_DB_COLLECTION_NAME: ${{ secrets.MONGO_DB_COLLECTION_NAME }}

      - name: 🧪 Test Job Matching Process
        if: ${{ github.event.inputs.test_type == 'matching' }}
        run: npm run job-matching-test
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_DB_COLLECTION_NAME: ${{ secrets.MONGO_DB_COLLECTION_NAME }}
          EMAIL_USER: ${{ secrets.MAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENTS }}

      - name: ✅ Send Test Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "✅ Job Matching Test Passed - ${{ github.event.inputs.test_type }}"
          to: ${{ secrets.MAIL_RECIPIENTS || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ✅ Job Matching Test (${{ github.event.inputs.test_type }}) completed successfully.
            
            📅 Timestamp: $(date)
            🔄 Test Type: ${{ github.event.inputs.test_type }}
            📝 All tests passed successfully.

      - name: ❌ Send Test Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "❌ Job Matching Test Failed - ${{ github.event.inputs.test_type }}"
          to: ${{ secrets.MAIL_RECIPIENTS || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ❌ Job Matching Test (${{ github.event.inputs.test_type }}) failed.
            
            🔍 Please check the workflow logs for error details.
            
            📅 Timestamp: $(date)
            🔄 Test Type: ${{ github.event.inputs.test_type }}
            🚨 Action Required: Review and fix the issue.
