name: Actively Hiring Detection System

on:
  schedule:
    - cron: "0 * * * *"  # Every hour at minute 0
  workflow_dispatch: # Manual trigger option

jobs:
  run-actively-hiring-detection:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üì¶ Install Project Dependencies
        run: npm install

      - name: üèÉ Run Actively Hiring Detection Process
        id: actively_hiring
        run: npm run actively-hiring 2>&1 | tee actively_hiring_output.txt
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
          MONGO_DB_COLLECTION_NAME: ${{ secrets.MONGO_DB_COLLECTION_NAME }}
          EMAIL_USER: ${{ secrets.MAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENT }}

      - name: üìä Create Summary Table
        if: success()
        run: |
          echo "## üìä Actively Hiring Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Extract values from output
          TOTAL_COMPANIES=$(grep -oP 'Total Companies Processed: \K\d+' actively_hiring_output.txt || echo "N/A")
          COMPANIES_UPDATED=$(grep -oP 'Companies Updated: \K\d+' actively_hiring_output.txt || echo "N/A")
          ACTIVELY_HIRING=$(grep -oP 'Actively Hiring: \K\d+' actively_hiring_output.txt || echo "N/A")
          NOT_ACTIVELY_HIRING=$(grep -oP 'Not Actively Hiring: \K\d+' actively_hiring_output.txt || echo "N/A")
          ERRORS=$(grep -oP 'Errors: \K\d+' actively_hiring_output.txt || echo "0")
          PROCESSING_TIME=$(grep -oP 'Processing Time: \K\d+' actively_hiring_output.txt || echo "N/A")
          
          echo "| Total Companies Processed | $TOTAL_COMPANIES |" >> $GITHUB_STEP_SUMMARY
          echo "| Companies Updated | $COMPANIES_UPDATED |" >> $GITHUB_STEP_SUMMARY
          echo "| Actively Hiring | $ACTIVELY_HIRING |" >> $GITHUB_STEP_SUMMARY
          echo "| Not Actively Hiring | $NOT_ACTIVELY_HIRING |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| Processing Time (seconds) | $PROCESSING_TIME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract actively hiring company names (lines with ‚úÖ marker)
          grep -oP '‚úÖ \K[^:]+' actively_hiring_output.txt > actively_hiring_companies.txt || touch actively_hiring_companies.txt
          
          # Display actively hiring companies table
          echo "### üè¢ Actively Hiring Companies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SR No | Company Name |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -s actively_hiring_companies.txt ]; then
            SR_NO=1
            while IFS= read -r company_name; do
              echo "| $SR_NO | $company_name |" >> $GITHUB_STEP_SUMMARY
              SR_NO=$((SR_NO + 1))
            done < actively_hiring_companies.txt
          else
            echo "| - | No companies actively hiring |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Actively hiring detection completed successfully!" >> $GITHUB_STEP_SUMMARY
          
          # Save values to file for email step
          echo "TOTAL_COMPANIES=$TOTAL_COMPANIES" >> summary.env
          echo "COMPANIES_UPDATED=$COMPANIES_UPDATED" >> summary.env
          echo "ACTIVELY_HIRING=$ACTIVELY_HIRING" >> summary.env
          echo "NOT_ACTIVELY_HIRING=$NOT_ACTIVELY_HIRING" >> summary.env
          echo "ERRORS=$ERRORS" >> summary.env
          echo "PROCESSING_TIME=$PROCESSING_TIME" >> summary.env

      - name: üìß Load Summary Values
        if: success()
        run: |
          if [ -f summary.env ]; then
            # Read summary.env line by line and only process valid variable assignments
            # This avoids issues with HTML content that might be in the file
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines and lines that don't look like variable assignments
              if [ -z "$line" ] || ! echo "$line" | grep -qE '^[A-Z_]+='; then
                continue
              fi
              
              # Skip lines with HTML tags (these would cause syntax errors)
              if echo "$line" | grep -qE '<[^>]+>'; then
                continue
              fi
              
              # Extract variable name and value
              VAR_NAME=$(echo "$line" | cut -d'=' -f1)
              VAR_VALUE=$(echo "$line" | cut -d'=' -f2-)
              
              # Only set known variables
              case "$VAR_NAME" in
                TOTAL_COMPANIES|COMPANIES_UPDATED|ACTIVELY_HIRING|NOT_ACTIVELY_HIRING|ERRORS|PROCESSING_TIME)
                  echo "${VAR_NAME}=${VAR_VALUE}" >> $GITHUB_ENV
                  ;;
              esac
            done < summary.env
          fi
          
          # Build HTML table for actively hiring companies
          if [ -f actively_hiring_companies.txt ] && [ -s actively_hiring_companies.txt ]; then
            SR_NO=1
            TABLE_ROWS=""
            while IFS= read -r company_name; do
              # Escape HTML special characters in company name
              COMPANY_NAME_ESC=$(echo "$company_name" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
              TABLE_ROWS="${TABLE_ROWS}<tr><td style=\"border:1px solid #ddd;padding:8px;\">${SR_NO}</td><td style=\"border:1px solid #ddd;padding:8px;\">${COMPANY_NAME_ESC}</td></tr>"
              SR_NO=$((SR_NO + 1))
            done < actively_hiring_companies.txt
            # Use heredoc to write HTML content safely to GITHUB_ENV
            echo "ACTIVELY_HIRING_COMPANIES_TABLE<<EOF" >> $GITHUB_ENV
            echo "$TABLE_ROWS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "ACTIVELY_HIRING_COMPANIES_TABLE=<tr><td colspan=\"2\" style=\"border:1px solid #ddd;padding:8px;text-align:center;\">No companies actively hiring</td></tr>" >> $GITHUB_ENV
          fi

      - name: ‚úÖ Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Actively Hiring Detection Success: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ‚úÖ The actively hiring detection ran successfully (hourly schedule).
            üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}
            
            Summary:
            - Total Companies Processed: ${{ env.TOTAL_COMPANIES || 'N/A' }}
            - Companies Updated: ${{ env.COMPANIES_UPDATED || 'N/A' }}
            - Actively Hiring: ${{ env.ACTIVELY_HIRING || 'N/A' }}
            - Not Actively Hiring: ${{ env.NOT_ACTIVELY_HIRING || 'N/A' }}
            - Errors: ${{ env.ERRORS || '0' }}
            - Processing Time (seconds): ${{ env.PROCESSING_TIME || 'N/A' }}
          html_body: |
            <div style="font-family:Arial, sans-serif;">
              <h3 style="margin:0 0 8px 0;">Actively Hiring Companies</h3>
              <table style="border-collapse:collapse;width:100%;">
                <thead>
                  <tr>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;">SR No</th>
                    <th style="border:1px solid #ddd;padding:8px;text-align:left;">Company Name</th>
                  </tr>
                </thead>
                <tbody>
                  ${{ env.ACTIVELY_HIRING_COMPANIES_TABLE || '<tr><td colspan="2" style="border:1px solid #ddd;padding:8px;">No companies actively hiring</td></tr>' }}
                </tbody>
              </table>
            </div>

      - name: ‚ùå Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Actively Hiring Detection Failed: $(date)"
          to: ${{ secrets.MAIL_RECIPIENT || 'nodooin86@gmail.com' }}
          from: "GitHub Action <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ‚ùå The actively hiring detection failed to complete successfully.
            üìÖ Timestamp: ${{ github.event.head_commit.timestamp }}

